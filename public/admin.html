<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Beano's Hub Admin Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#fff7f0,#ffe6d4);min-height:100vh;display:flex;flex-direction:column;align-items:center;padding-bottom:40px;}
h1{margin:40px 0 20px;font-size:2.2rem;color:#5a3e36;text-align:center;}
.card-container{display:flex;flex-wrap:wrap;justify-content:center;gap:25px;width:95%;max-width:1000px;}
.card{background:#fff1eb;border-radius:20px;padding:25px;width:300px;box-shadow:0 10px 25px rgba(0,0,0,0.08);display:flex;flex-direction:column;align-items:center;transition:transform 0.3s ease,box-shadow 0.3s ease;}
.card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,0.12);}
.card h2{margin-bottom:15px;font-size:1.5rem;color:#4b2e25;}
.image-box{width:100%;height:180px;background:#f5d1c1;border-radius:12px;margin-bottom:15px;display:flex;justify-content:center;align-items:center;color:#7a4a3c;font-weight:600;font-size:1rem;}
input[type=file],input[type=password]{width:100%;padding:10px;border-radius:10px;border:none;margin-bottom:12px;font-size:14px;outline:none;}
input[type=file]{cursor:pointer;} input[type=password]{display:none;}
button{width:100%;padding:12px;border-radius:12px;border:none;font-weight:600;font-size:15px;color:#fff;background:#ff6b35;cursor:pointer;transition:background 0.3s ease;}
button:hover{background:#e55a2b;}
@media(max-width:600px){.card{width:90%;padding:20px;}}
/* Loading overlay */
#overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);
  display:none;justify-content:center;align-items:center;z-index:999;
  color:#fff;font-size:1.5rem;font-weight:600;
}
/* Auth section */
.auth-section {
  background: #ffffff;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  text-align: center;
  max-width: 450px;
  margin: 60px auto;
  display: none;
}
</style>
</head>
<body>
<div id="authSection" class="auth-section">
  <h2 style="margin-bottom:20px; color:#343a40;">Admin Login</h2>
  <input type="password" id="pinInput" placeholder="Enter Admin PIN">
  <button onclick="login()">Login</button>
</div>

<div id="mainSection" style="display:none;">
  <h1>Beano's Hub Admin Panel</h1>
  <div class="card-container">
    <div class="card">
      <h2>Birthday Theatre</h2>
      <div class="image-box" id="birthdayImageBox">Loading...</div>
      <input type="file" id="birthdayFile">
      <button id="birthdayBtn">Upload</button>
    </div>
    <div class="card">
      <h2>Couple Theatre</h2>
      <div class="image-box" id="coupleImageBox">Loading...</div>
      <input type="file" id="coupleFile">
      <button id="coupleBtn">Upload</button>
    </div>
    <div class="card">
      <h2>Private Theatre</h2>
      <div class="image-box" id="privateImageBox">Loading...</div>
      <input type="file" id="privateFile">
      <button id="privateBtn">Upload</button>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="overlay">Processing...</div>

<script>
const overlay = document.getElementById("overlay");
const authSection = document.getElementById("authSection");
const mainSection = document.getElementById("mainSection");
let accessToken = localStorage.getItem("accessToken");
let refreshToken = localStorage.getItem("refreshToken");
let adminSecret = localStorage.getItem("adminSecret") || '';

async function login() {
  const pin = document.getElementById("pinInput").value;
  if (!pin) {
    alert("Please enter the Admin PIN.");
    return;
  }
  overlay.style.display = "flex";
  try {
    const res = await fetch("/api/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pin })
    });
    const data = await res.json();
    if (data.success) {
      accessToken = data.accessToken;
      refreshToken = data.refreshToken;
      adminSecret = data.adminSecret;
      localStorage.setItem("accessToken", accessToken);
      localStorage.setItem("refreshToken", refreshToken);
      localStorage.setItem("adminSecret", adminSecret);
      authSection.style.display = "none";
      mainSection.style.display = "block";
      loadImages();
    } else {
      throw new Error(data.message);
    }
  } catch (err) {
    overlay.style.display = "none";
    alert(`Login failed: ${err.message}`);
  }
}

async function refreshAccessToken() {
  if (!refreshToken) {
    authSection.style.display = "block";
    mainSection.style.display = "none";
    return false;
  }
  try {
    const res = await fetch("/api/refresh-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refreshToken })
    });
    const data = await res.json();
    if (data.success) {
      accessToken = data.accessToken;
      localStorage.setItem("accessToken", accessToken);
      return true;
    } else {
      throw new Error(data.message);
    }
  } catch (err) {
    localStorage.removeItem("accessToken");
    localStorage.removeItem("refreshToken");
    localStorage.removeItem("adminSecret");
    authSection.style.display = "block";
    mainSection.style.display = "none";
    alert("Session expired. Please log in again.");
    return false;
  }
}

// Load latest images from API
async function loadImages() {
  if (!accessToken && !await refreshAccessToken()) return;
  try {
    const res = await fetch("/api/images", {
      headers: { "Authorization": `Bearer ${accessToken}` }
    });
    if (res.status === 403 && await refreshAccessToken()) {
      return loadImages(); // Retry with new token
    }
    const images = await res.json();
    const ts = Date.now();
    document.getElementById("birthdayImageBox").innerHTML = `<img src="${images.birthday}?t=${ts}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
    document.getElementById("coupleImageBox").innerHTML = `<img src="${images.couple}?t=${ts}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
    document.getElementById("privateImageBox").innerHTML = `<img src="${images.private}?t=${ts}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
  } catch (err) {
    console.error(err);
    alert("Failed to load images");
  }
}

// Upload handlers
const setups = [
  {fileId:'birthdayFile', boxId:'birthdayImageBox', btnId:'birthdayBtn', theatre:'birthday'},
  {fileId:'coupleFile', boxId:'coupleImageBox', btnId:'coupleBtn', theatre:'couple'},
  {fileId:'privateFile', boxId:'privateImageBox', btnId:'privateBtn', theatre:'private'}
];

setups.forEach(({fileId, boxId, btnId, theatre})=>{
  const fileInput = document.getElementById(fileId);
  const btn = document.getElementById(btnId);
  const imgBox = document.getElementById(boxId);

  fileInput.addEventListener("change", e=>{
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = () => {
        imgBox.innerHTML = `<img src="${reader.result}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
      }
      reader.readAsDataURL(file);
    }
  });

  btn.addEventListener("click", async ()=>{
    const file = fileInput.files[0];
    if(!file) { alert("Select an image"); return; }
    const formData = new FormData();
    formData.append("image", file);
    
    if (!accessToken && !await refreshAccessToken()) return;
    
    try {
      overlay.style.display = "flex";
      const res = await fetch("/upload/"+theatre, {
        method: "POST",
        headers: { "Authorization": `Bearer ${accessToken}` },
        body: formData
      });
      if (res.status === 403 && await refreshAccessToken()) {
        return btn.click(); // Retry with new token
      }
      const data = await res.json();
      overlay.style.display = "none";
      alert(data.message);
      window.location.reload();
    } catch (err) {
      overlay.style.display = "none";
      alert("Upload failed!");
      window.location.reload();
    }
  });
});

// Check for existing token on page load
if (accessToken) {
  authSection.style.display = "none";
  mainSection.style.display = "block";
  loadImages();
} else {
  authSection.style.display = "block";
}
</script>
</body>
</html>